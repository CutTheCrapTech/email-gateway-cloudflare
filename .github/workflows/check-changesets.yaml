# .github/workflows/changeset-check.yml
name: Changeset Check

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

jobs:
  changeset-reminder:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
    env:
      # Configurable file extensions (comma-separated)
      INCLUDE_FILE_EXTENSIONS: "ts,js,json"
      EXCLUDE_FILE_EXTENSIONS: "test.ts,test.js,spec.ts,spec.js"
      EXCLUDE_DIRECTORIES: "__tests__"

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          fetch-depth: 0

      - name: Check for changesets
        id: changesets
        run: |
          # Check if there are any changesets (excluding README)
          if [ -z "$(ls .changeset/*.md 2>/dev/null | grep -v README)" ]; then
            echo "missing=true" >> $GITHUB_OUTPUT
            echo "No changesets found"
          else
            echo "missing=false" >> $GITHUB_OUTPUT
            echo "Changesets found:"
            ls .changeset/*.md | grep -v README || true
          fi

      - name: Check if PR affects user-facing code
        id: files
        run: |
          # Get changed files
          FILES=$(git diff --name-only origin/main...HEAD)
          echo "Changed files:"
          echo "$FILES"

          # Generate regex patterns from extensions
          INCLUDE_REGEX=$(echo "$INCLUDE_FILE_EXTENSIONS" | sed 's/,/\\$|\\./g' | sed 's/^/\\./' | sed 's/$/\\$/')
          EXCLUDE_REGEX=$(echo "$EXCLUDE_FILE_EXTENSIONS" | sed 's/,/\\$|\\./g' | sed 's/^/\\./' | sed 's/$/\\$/')

          # Add directory exclusions if specified
          if [ -n "$EXCLUDE_DIRECTORIES" ]; then
            DIR_REGEX=$(echo "$EXCLUDE_DIRECTORIES" | sed 's/,/|/g')
            EXCLUDE_REGEX="$EXCLUDE_REGEX|$DIR_REGEX"
          fi

          echo "Include extensions: $INCLUDE_FILE_EXTENSIONS"
          echo "Exclude extensions: $EXCLUDE_FILE_EXTENSIONS"
          echo "Exclude directories: $EXCLUDE_DIRECTORIES"
          echo "Generated include regex: $INCLUDE_REGEX"
          echo "Generated exclude regex: $EXCLUDE_REGEX"

          # Find files that match include patterns
          MATCHING_FILES=$(printf '%s\n' $FILES | grep -E "$INCLUDE_REGEX" || true)

          if [ -n "$MATCHING_FILES" ]; then
            echo "Files matching include extensions:"
            echo "$MATCHING_FILES"

            # Filter out files that match exclude patterns
            USER_FACING_FILES=$(echo "$MATCHING_FILES" | grep -v -E "$EXCLUDE_REGEX" || true)

            if [ -n "$USER_FACING_FILES" ]; then
              echo "user_facing=true" >> $GITHUB_OUTPUT
              echo "User-facing code changes detected:"
              echo "$USER_FACING_FILES"
            else
              echo "user_facing=false" >> $GITHUB_OUTPUT
              echo "All matching files are excluded (tests, etc.)"
            fi
          else
            echo "user_facing=false" >> $GITHUB_OUTPUT
            echo "No files matching include extensions found"
          fi

      - name: Comment on PR
        if: steps.changesets.outputs.missing == 'true' && steps.files.outputs.user_facing == 'true'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.login === 'github-actions[bot]' &&
              comment.body.includes('ğŸ“ Changeset Reminder')
            );

            const commentBody = `## ğŸ“ Changeset Reminder

            This PR appears to modify user-facing code but doesn't include a changeset.

            **If this introduces changes that should be released**, please add a changeset:
            \`\`\`bash
            npx changeset
            \`\`\`

            **If this shouldn't trigger a release**, you can ignore this message.

            <details>
            <summary>What needs a changeset?</summary>

            **Needs changeset:**
            - âœ… New features
            - âœ… Bug fixes
            - âœ… Breaking changes
            - âœ… Performance improvements
            - âœ… API changes

            **Doesn't need changeset:**
            - âŒ Documentation updates
            - âŒ Test changes
            - âŒ Internal refactoring
            - âŒ CI/tooling changes
            - âŒ Dependency updates (unless they affect users)
            </details>

            ---
            <sub>This is an automated reminder. The PR can still be merged without a changeset.</sub>`;

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
            }

      - name: Remove changeset comment if not needed
        if: steps.changesets.outputs.missing == 'false' || steps.files.outputs.user_facing == 'false'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.login === 'github-actions[bot]' &&
              comment.body.includes('ğŸ“ Changeset Reminder')
            );

            if (botComment) {
              await github.rest.issues.deleteComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id
              });
            }

      - name: Always succeed
        run: echo "âœ… Changeset check completed (non-blocking)"
