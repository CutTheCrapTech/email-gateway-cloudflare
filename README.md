# email-gateway-cloudflare

A Cloudflare Worker for secure email forwarding. It integrates [`email-alias-core`](https://github.com/CutTheCrapTech/email-alias-core) to form a private email gateway on Cloudflare.

## Features

- **Secure Email Forwarding:** Uses HMAC-based email aliases to verify incoming emails, preventing unauthorized use of your email domain.
- **Email Alias Generation:** Email aliases are generated by companion browser extensions for [Chrome](https://chromewebstore.google.com/detail/email-alias-generator/ghhkompkfhenihpidldalcocbfplkdgm) and [Firefox](https://addons.mozilla.org/en-US/firefox/addon/email-alias-generator-hmac/), ensuring seamless integration and ease of use.
- **Cloudflare Native:** Built to run entirely on the Cloudflare serverless platform.
- **Infrastructure as Code:** Designed to be deployed via Terraform.

## Architecture

This project consists of a Cloudflare Worker that is the core of the email gateway. It's responsible for:

- Receiving all emails sent to your domain.
- Validating the recipient alias using `email-alias-core`.
- Forwarding the validated email to your real inbox.

### A Note on Email Sanitization

This project was intended to integrate the [`email-sanitizer`](https://github.com/CutTheCrapTech/email-scrubber-core) library to strip tracking pixels and clean URLs from incoming emails. However, Cloudflare Email Workers do not currently support modifying the body of an email. Once this feature becomes available, `email-sanitizer` will be integrated.

## Configuration

The Worker requires the following configuration:

### Environment Variables

- `EMAIL_OPTIONS`: JSON string containing configuration options
- `DOMAIN`: Your email domain (e.g., "example.com")

### Secrets

- `EMAIL_SECRET_MAPPING`: JSON string mapping secret keys to destination email addresses

### Configuration Examples

**EMAIL_OPTIONS**:

```json
{
  "default_email_address": "your-real-email@gmail.com",
  "ignore_email_checks": ["trusted-receiver@example.com"]
}
```

**EMAIL_SECRET_MAPPING**:

```json
{
  "secret1": "user1@gmail.com",
  "secret2": "user2@gmail.com"
}
```

## Deployment Options

Choose the deployment method that best fits your needs:

### Option 1: Terraform (Recommended for people using the homelab repository)

Use the complete infrastructure setup from the [homelab repository](https://github.com/CutTheCrapTech/homelab/tree/main/tofu/cloudflare/email-alias/) which includes:

- Cloudflare Workers deployment
- Email routing configuration
- DNS setup
- Environment and secret management

This approach is ideal for production deployments and teams managing multiple environments.

### Option 2: Wrangler CLI (Recommended for others)

For direct deployment using Cloudflare's native tooling:

1. **Install Wrangler**:

   ```bash
   npm install
   ```

2. **Authenticate with Cloudflare**:

   ```bash
   npx wrangler login
   ```

3. **Build the worker**:

   ```bash
   npm run build
   ```

4. **Create configuration**:

   ```bash
   cp wrangler.toml.template wrangler.toml
   ```

   Edit `wrangler.toml` with your values:

   ```toml
   name = "email-gateway-prod"
   main = "dist/worker.js"
   compatibility_date = "2025-07-08"

   [vars]
   EMAIL_OPTIONS = '{"default_email_address":"your-real-email@gmail.com","ignore_email_checks":["trusted-receiver@example.com"]}'

   [[email]]
   name = "email-gateway-prod"
   destination_confirmed = true
   ```

5. **Set secrets**:

   ```bash
   wrangler secret put EMAIL_SECRET_MAPPING
   ```

   When prompted, paste your JSON mapping:

   ```json
   { "secret1": "user1@gmail.com", "secret2": "user2@gmail.com" }
   ```

6. **Deploy**:

   ```bash
   wrangler deploy
   ```

7. **Configure Email Routing**:
   - Go to your domain in Cloudflare Dashboard
   - Navigate to **Email** → **Email Routing** → **Routing Rules**
   - Enable catch-all with your Worker as the destination

### Option 3: Manual Deployment (Beginner-friendly)

For a simple one-time setup without additional tooling:

1. **Download the worker code**:
   - Go to the [latest GitHub release](https://github.com/CutTheCrapTech/email-gateway-cloudflare/releases/latest)
   - Download the "Built artifacts" asset (e.g., `worker v1.0.1.js`)

2. **Access Cloudflare Dashboard**:
   - Log in to your [Cloudflare Dashboard](https://dash.cloudflare.com/)
   - Navigate to **Workers & Pages** → **Create Application** → **Create Worker**

3. **Upload the code**:
   - Replace the default code with the contents of the downloaded worker file (e.g., `worker v1.0.1.js`)
   - Click **Save and Deploy**

4. **Configure Environment Variables**:
   - Go to **Settings** → **Variables and Secrets**
   - Add these text variables:
     - `EMAIL_OPTIONS`: `{"default_email_address":"your-real-email@gmail.com","ignore_email_checks":["trusted-receiver@example.com"]}`

5. **Set Secrets**:
   - In the same **Variables and Secrets** section, add a variable of type secret:
     - `EMAIL_SECRET_MAPPING`: `{"secret1": "user1@gmail.com", "secret2": "user2@gmail.com"}`

6. **Configure Email Routing**:
   - Go to your domain in Cloudflare Dashboard
   - Navigate to **Email** → **Email Routing** → **Routing Rules**
   - Enable catch-all with your Worker as the destination

## Email Routing Setup

Regardless of deployment method, you need to configure Cloudflare Email Routing:

1. **Enable Email Routing** for your domain in the Cloudflare Dashboard
2. **Add MX records** (Cloudflare will prompt you to do this)
3. **Configure routing rules** to send emails to your Worker
4. **Verify your destination email** address

## Development

### Prerequisites

- Node.js and npm
- A local `git` client

### Building

To build the project locally, install the dependencies and run the build script:

```bash
npm install
npm run build
```

This will generate the bundled JavaScript files in the `dist/` directory.

### Testing

Run the test suite:

```bash
npm test
```

### Code Quality

Check types, linting, and run tests:

```bash
npm run check
```

## Release Process

The release process is automated via GitHub Actions, which builds the worker script and attaches it to a GitHub Release. Your deployment method can then pull this asset directly.

## License

This project is licensed under the **MIT License**. See the [LICENSE](LICENSE) file for details.
